{{- $seed := .Values.secretSeed | required "secretSeed is required" }}
{{- $appNamespaces := list }}
{{- range .Values.appsEnabled }}
{{- $appNamespaces = append $appNamespaces (printf "lasuite-%s" .) }}
{{- end }}
{{- $namespaces := join "," $appNamespaces }}
---
# PostgreSQL admin credentials (for creating app databases)
apiVersion: v1
kind: Secret
metadata:
  name: postgresql-admin
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "platform-configuration.labels" . | nindent 4 }}
type: Opaque
stringData:
  postgres-password: "{{ include "deriveSecret" (dict "seed" $seed "clientId" "postgres-admin") }}"
  password: "{{ include "deriveSecret" (dict "seed" $seed "clientId" "postgres") }}"
---
# PostgreSQL app user credentials (replicated to app namespaces)
apiVersion: v1
kind: Secret
metadata:
  name: postgresql-credentials
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "platform-configuration.labels" . | nindent 4 }}
  {{- if $namespaces }}
  annotations:
    {{- include "reflector.annotations" $namespaces | nindent 4 }}
  {{- end }}
type: Opaque
stringData:
  host: "{{ .Values.postgres.host }}"
  port: "{{ .Values.postgres.port }}"
  username: "lasuite"
  password: "{{ include "deriveSecret" (dict "seed" $seed "clientId" "postgres") }}"
