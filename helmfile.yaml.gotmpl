# ===========================================
# HELM REPOSITORIES
# ===========================================
repositories:
  - name: bitnami
    url: https://charts.bitnami.com/bitnami
  - name: minio
    url: https://charts.min.io/
  - name: codecentric
    url: https://codecentric.github.io/helm-charts
  - name: jetstack
    url: https://charts.jetstack.io
  - name: haproxytech
    url: https://haproxytech.github.io/helm-charts
  - name: emberstack
    url: https://emberstack.github.io/helm-charts
  - name: docs
    url: https://suitenumerique.github.io/docs/
  - name: meet
    url: https://suitenumerique.github.io/meet/
  - name: drive
    url: https://suitenumerique.github.io/drive/
  - name: people
    url: https://suitenumerique.github.io/people/
  - name: conversations
    url: https://suitenumerique.github.io/conversations/
  - name: livekit
    url: https://helm.livekit.io

# ===========================================
# HELM DEFAULTS
# ===========================================
helmDefaults:
  wait: true
  waitForJobs: true
  timeout: 600
  createNamespace: true

# ===========================================
# ENVIRONMENTS
# ===========================================
environments:
  local:
    values:
      - versions/backend-helm-versions.yaml
      - versions/lasuite-helm-versions.yaml
      - environments/local.yaml
      - environments/_computed.yaml.gotmpl

  # Template for remote deployments - copy and adapt
  # remote-example:
  #   values:
  #     - versions/backend-helm-versions.yaml
  #     - versions/lasuite-helm-versions.yaml
  #     - environments/<name>.yaml
  #     - environments/_computed.yaml.gotmpl

---
# ===========================================
# RELEASES
# ===========================================
releases:
  # -------------------------------------------
  # CERT-MANAGER
  # -------------------------------------------
  - name: cert-manager
    namespace: cert-manager
    chart: jetstack/cert-manager
    version: {{ .Values.chartVersions.certManager | quote }}
    condition: certManager.enabled
    labels:
      category: infrastructure
    values:
      - values/cert-manager.yaml.gotmpl

  # -------------------------------------------
  # HAPROXY INGRESS CONTROLLER
  # -------------------------------------------
  - name: haproxy-ingress
    namespace: haproxy-controller
    chart: haproxytech/kubernetes-ingress
    version: {{ .Values.chartVersions.haproxy | quote }}
    condition: ingress.enabled
    labels:
      category: infrastructure
    values:
      - values/haproxy-ingress.yaml.gotmpl

  # -------------------------------------------
  # REFLECTOR
  # -------------------------------------------
  - name: reflector
    namespace: reflector
    chart: emberstack/reflector
    version: {{ .Values.chartVersions.reflector | quote }}
    condition: reflector.enabled
    labels:
      category: infrastructure

  # -------------------------------------------
  # POSTGRESQL
  # -------------------------------------------
  - name: lasuite-postgresql
    namespace: lasuite-postgresql
    chart: bitnami/postgresql
    version: {{ .Values.chartVersions.postgresql | quote }}
    condition: postgres.enabled
    labels:
      category: infrastructure
    values:
      - values/postgresql.yaml.gotmpl

  # -------------------------------------------
  # REDIS
  # -------------------------------------------
  - name: redis
    namespace: lasuite-redis
    chart: bitnami/redis
    version: {{ .Values.chartVersions.redis | quote }}
    condition: redis.enabled
    labels:
      category: infrastructure
    values:
      - values/redis.yaml.gotmpl

  # -------------------------------------------
  # KEYCLOAK
  # -------------------------------------------
  - name: keycloak
    namespace: lasuite-keycloak
    chart: codecentric/keycloakx
    version: {{ .Values.chartVersions.keycloak | quote }}
    condition: keycloak.enabled
    needs:
      - lasuite-config/platform-configuration
      {{- if .Values.postgres.enabled }}
      - lasuite-postgresql/lasuite-postgresql
      {{- end }}
    labels:
      category: infrastructure
    values:
      - values/keycloak.yaml.gotmpl

  # -------------------------------------------
  # MINIO (dev only)
  # -------------------------------------------
  - name: minio
    namespace: lasuite-minio
    chart: minio/minio
    version: {{ .Values.chartVersions.minio | quote }}
    condition: minio.enabled
    labels:
      category: infrastructure
    values:
      - values/minio.yaml.gotmpl

  # -------------------------------------------
  # PLATFORM CONFIGURATION
  # -------------------------------------------
  - name: platform-configuration
    namespace: lasuite-config
    chart: ./helm/platform-configuration
    needs:
      {{- if .Values.certManager.enabled }}
      - cert-manager/cert-manager
      {{- end }}
      {{- if .Values.reflector.enabled }}
      - reflector/reflector
      {{- end }}
    labels:
      category: infrastructure
    values:
      - values/platform-configuration.yaml.gotmpl

  # -------------------------------------------
  # DOCS
  # -------------------------------------------
  - name: docs
    namespace: lasuite-docs
    chart: docs/docs
    version: {{ .Values.chartVersions.docs | quote }}
    condition: apps.docs.enabled
    needs:
      - lasuite-config/platform-configuration
      {{- if .Values.postgres.enabled }}
      - lasuite-postgresql/lasuite-postgresql
      {{- end }}
      {{- if .Values.redis.enabled }}
      - lasuite-redis/redis
      {{- end }}
      {{- if .Values.keycloak.enabled }}
      - lasuite-keycloak/keycloak
      {{- end }}
      {{- if .Values.minio.enabled }}
      - lasuite-minio/minio
      {{- end }}
    labels:
      category: business
      app: docs
    values:
      - values/docs.yaml.gotmpl

  # -------------------------------------------
  # DRIVE
  # -------------------------------------------
  - name: drive
    namespace: lasuite-drive
    chart: drive/drive
    version: {{ .Values.chartVersions.drive | quote }}
    condition: apps.drive.enabled
    needs:
      - lasuite-config/platform-configuration
      {{- if .Values.postgres.enabled }}
      - lasuite-postgresql/lasuite-postgresql
      {{- end }}
      {{- if .Values.redis.enabled }}
      - lasuite-redis/redis
      {{- end }}
      {{- if .Values.keycloak.enabled }}
      - lasuite-keycloak/keycloak
      {{- end }}
      {{- if .Values.minio.enabled }}
      - lasuite-minio/minio
      {{- end }}
    labels:
      category: business
      app: drive
    values:
      - values/drive.yaml.gotmpl

  # -------------------------------------------
  # LIVEKIT (for Meet)
  # -------------------------------------------
  - name: livekit
    namespace: lasuite-livekit
    chart: livekit/livekit-server
    version: {{ .Values.chartVersions.livekit | quote }}
    condition: livekit.enabled
    needs:
      - lasuite-config/platform-configuration
      {{- if .Values.redis.enabled }}
      - lasuite-redis/redis
      {{- end }}
    labels:
      category: infrastructure
    values:
      - values/livekit.yaml.gotmpl

  # -------------------------------------------
  # MEET
  # -------------------------------------------
  - name: meet
    namespace: lasuite-meet
    chart: meet/meet
    version: {{ .Values.chartVersions.meet | quote }}
    condition: apps.meet.enabled
    needs:
      - lasuite-config/platform-configuration
      {{- if .Values.postgres.enabled }}
      - lasuite-postgresql/lasuite-postgresql
      {{- end }}
      {{- if .Values.redis.enabled }}
      - lasuite-redis/redis
      {{- end }}
      {{- if .Values.keycloak.enabled }}
      - lasuite-keycloak/keycloak
      {{- end }}
      {{- if .Values.livekit.enabled }}
      - lasuite-livekit/livekit
      {{- end }}
    labels:
      category: business
      app: meet
    values:
      - values/meet.yaml.gotmpl
